generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String     @id
  name               String
  email              String
  emailVerified      Boolean    @default(false)
  role               UserRole   @default(PATIENT)
  status             UserStatus @default(ACTIVE)
  needPasswordChange Boolean    @default(false)
  isDeleted          Boolean    @default(false)
  deletedAt          DateTime?
  image              String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  sessions           Session[]
  accounts           Account[]

  patient Patient?
  doctor  Doctor?
  admin   Admin?

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Patient {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  profilePhoto  String?
  contactNumber String?
  address       String?
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  appointments      Appointment[]
  prescriptions     Prescription[]
  medicalReports    MedicalReport[]
  reviews           Review[]
  patientHealthData PatientHealthData?

  @@index([email], name: "idx_patient_email")
  @@index([isDeleted], name: "idx_patient_isDeleted")
  @@map("patient")
}

model Doctor {
  id String @id @default(uuid(7))

  name                String
  email               String    @unique
  profilePhoto        String?
  contactNumber       String?
  address             String?
  isDeleted           Boolean   @default(false)
  deletedAt           DateTime?
  registrationNumber  String?
  experience          Int       @default(0)
  gender              Gender
  appointmentFee      Float
  qualification       String
  currentWorkingPlace String
  designation         String
  averageRating       Float     @default(0.0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  specialties     DoctorSpecialty[]
  appointments    Appointment[]
  doctorSchedules DoctorSchedules[]
  prescriptions   Prescription[]
  reviews         Review[]

  @@index([email], name: "idx_doctor_email")
  @@index([isDeleted], name: "idx_doctor_isDeleted")
  @@map("doctor")
}

model Specialty {
  id          String  @id @default(uuid(7))
  title       String  @unique @db.VarChar(100)
  description String? @db.Text
  icon        String  @db.VarChar(255)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  doctorSpecialties DoctorSpecialty[]

  @@index([isDeleted], name: "idx_specialty_isDeleted")
  @@index([title], name: "idx_specialty_title")
  @@map("specialties")
}

model DoctorSpecialty {
  id          String @id @default(uuid(7))
  doctorId    String
  specialtyId String

  doctor    Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  specialty Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([doctorId, specialtyId])
  @@index([doctorId], name: "idx_doctor_specialty_doctorId")
  @@index([specialtyId], name: "idx_doctor_specialty_specialtyId")
  @@map("doctor_specialties")
}

model Appointment {
  id             String            @id @default(uuid(7))
  videoCallingId String            @unique @db.Uuid()
  status         AppointmentStatus @default(SCHEDULED)
  paymentStatus  PaymentStatus     @default(UNPAID)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  scheduleId String
  schedule   Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  prescription Prescription?
  review       Review?
  payment      Payment?

  @@index([patientId])
  @@index([doctorId])
  @@index([scheduleId])
  @@index([status])
  @@map("appointments")
}

model Schedule {
  id            String   @id @default(uuid(7))
  startDateTime DateTime
  endDateTime   DateTime

  doctorSchedules DoctorSchedules[]
  appointments    Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("schedules")
}

model DoctorSchedules {
  doctorId String
  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  scheduleId String
  schedule   Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  isBooked  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([doctorId, scheduleId])
  @@index([doctorId])
  @@index([scheduleId])
  @@map("doctor_schedules")
}

model MedicalReport {
  id         String @id @default(uuid(7))
  reportName String
  reportLink String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("medical_reports")
}

model PatientHealthData {
  id                  String     @id @default(uuid(7))
  gender              Gender
  dateOfBirth         DateTime
  bloodGroup          BloodGroup
  hasAllergies        Boolean    @default(false)
  hasDiabetes         Boolean    @default(false)
  height              String
  weight              String
  smokingStatus       Boolean    @default(false)
  dietaryPreferences  String?
  pregnancyStatus     Boolean    @default(false)
  mentalHealthHistory String?
  immunizationStatus  String?
  hasPastSurgeries    Boolean    @default(false)
  recentAnxiety       Boolean    @default(false)
  recentDepression    Boolean    @default(false)
  maritalStatus       String?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  patientId String  @unique
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("patient_health_data")
}

model Prescription {
  id           String   @id @default(uuid(7))
  followUpDate DateTime
  instructions String   @db.Text
  pdfUrl       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  doctorId String
  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([appointmentId])
  @@index([patientId])
  @@index([doctorId])
  @@map("prescriptions")
}

model Review {
  id        String   @id @default(uuid(7))
  rating    Float    @default(0.0)
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([patientId])
  @@index([doctorId])
  @@map("reviews")
}

model Payment {
  id                 String        @id @default(uuid(7))
  amount             Float
  transactionId      String        @unique @db.Uuid()
  stripeEventId      String?       @unique
  status             PaymentStatus @default(UNPAID)
  invoiceUrl         String?
  paymentGatewayData Json?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([transactionId])
  @@map("payments")
}

model Admin {
  id            String    @id @default(uuid(7))
  name          String
  email         String    @unique
  profilePhoto  String?
  contactNumber String?
  isDeleted     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([isDeleted])
  @@map("admins")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  DOCTOR
  PATIENT
}

enum UserStatus {
  ACTIVE
  BLOCKED
  DELETED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum AppointmentStatus {
  SCHEDULED
  INPROGRESS
  COMPLETED
  CANCELED
}

enum PaymentStatus {
  PAID
  UNPAID
}
